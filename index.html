<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Transmitir Tela</title>
<style>
body {
    background: #000;
    color: white;
    font-family: Arial;
    text-align: center;
    padding: 20px;
}
button {
    padding: 15px 25px;
    border: none;
    background: #0a84ff;
    color: white;
    border-radius: 8px;
    font-size: 22px;
}
</style>
</head>
<body>

<h2>Toque para transmitir sua tela</h2>
<button id="btn">Iniciar transmissão</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6vf58vpJDL444wF7XkzF7kYPiVU73pVY",
  authDomain: "screenlink-7bbef.firebaseapp.com",
  databaseURL: "https://screenlink-7bbef-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "screenlink-7bbef",
  storageBucket: "screenlink-7bbef.appspot.com",
  messagingSenderId: "854919839518",
  appId: "1:854919839518:web:a91e2cc425f34e0290530f",
  measurementId: "G-SDVTFWVFF5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const room = "ROOM123";

document.getElementById("btn").onclick = async () => {
    let stream;
    try {
        stream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:false});
    } catch(e) {
        alert("Permissão necessária para começar a transmissão!");
        console.error(e);
        return;
    }

    const pc = new RTCPeerConnection();
    stream.getTracks().forEach(t => pc.addTrack(t, stream));

    const offerRef = ref(db, "rooms/" + room + "/offer");
    const answerRef = ref(db, "rooms/" + room + "/answer");
    const iceRef = ref(db, "rooms/" + room + "/phone_ice");

    pc.onicecandidate = (event) => {
        if(event.candidate) {
            set(iceRef, [...(iceRef._cache || []), event.candidate.toJSON()]);
        }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    set(offerRef, offer);

    onValue(answerRef, async (snap) => {
        const ans = snap.val();
        if(ans && !pc.remoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(ans));
        }
    });
};
</script>
</body>
</html>
