<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Receber Tela</title>
<style>
body{margin:0;background:#000;color:#fff;text-align:center;font-family:Arial;}
video{width:100%;height:80vh;margin-top:10px;}
#qrcode{margin-top:10px;}
</style>
</head>
<body>
<h2>Escaneie o QR para conectar o iPhone</h2>
<div id="qrcode"></div>
<video id="v" autoplay playsinline></video>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
window.onload = function() {
    console.log("Página carregada, iniciando script...");

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyD6vf58vpJDL444wF7XkzF7kYPiVU73pVY",
      authDomain: "screenlink-7bbef.firebaseapp.com",
      databaseURL: "https://screenlink-7bbef-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "screenlink-7bbef",
      storageBucket: "screenlink-7bbef.firebasestorage.app",
      messagingSenderId: "854919839518",
      appId: "1:854919839518:web:a91e2cc425f34e0290530f",
      measurementId: "G-SDVTFWVFF5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Gera sala aleatória
    const roomId = Math.random().toString(36).substring(2,8).toUpperCase();
    console.log("Room ID:", roomId);

    // Gera link do iPhone
    const baseURL = (window.location.origin && window.location.origin !== "null")
      ? window.location.origin + "/index.html?room=" + roomId
      : "https://pedraog.github.io/screenlink/index.html?room=" + roomId;

    console.log("Link para QR:", baseURL);

    // Gera QR code
    const qrDiv = document.getElementById('qrcode');
    if(!qrDiv) {
        console.error("Div para QR code não encontrada!");
        return;
    }

    if(typeof QRCode === "undefined") {
        console.error("Biblioteca QRCode não carregada!");
        return;
    }

    QRCode.toCanvas(qrDiv, baseURL, function(error) {
        if(error) {
            console.error("Erro ao gerar QR code:", error);
            alert("Erro ao gerar QR code. Abra o site via GitHub Pages.");
        } else {
            console.log("QR code gerado com sucesso!");
        }
    });

    // Configura WebRTC
    const pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    pc.ontrack = e => document.getElementById('v').srcObject = e.streams[0];

    db.ref('rooms/' + roomId + '/offer').on('value', async snapshot => {
      const offer = snapshot.val();
      if (!offer) return;
      console.log("Offer recebido, enviando answer...");
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      db.ref('rooms/' + roomId + '/answer').set(pc.localDescription.toJSON());
      console.log("Answer enviada!");
    });
};
</script>
</body>
</html>
